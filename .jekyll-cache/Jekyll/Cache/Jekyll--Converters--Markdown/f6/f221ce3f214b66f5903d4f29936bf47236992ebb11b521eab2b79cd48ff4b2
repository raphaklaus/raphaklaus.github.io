I"õ<p>Na postagem de hoje vou falar sobre a import√¢ncia que um Bot de Telegram teve para as Olimp√≠adas Rio 2016 e os bastidores de seu desenvolvimento.</p>

<!--more -->

<p>Era Maio de 2016 e <a href="http://lab21k.com.br" target="_blank">n√≥s</a> recebemos um requisito do Comit√™ Ol√≠mpico Brasileiro (COB) para cria√ß√£o de um sistema automatizado de distribui√ß√£o de informa√ß√µes usando dados dos Centro de Opera√ß√µes do Rio (COR) e do Centro Integrado de Comando e Controle (CICC) para as Olimp√≠adas Rio 2016 com as API‚Äôs Telegram Messenger e Telegram Bot.</p>

<p>Bom, eu nunca tinha mexido com APIs do Telegram. Muito menos com bots. Mas o resultado foi isso aqui: <a href="http://sportv.globo.com/videos/sportv-news/t/ultimos/v/tecnologia-auxilia-nos-treinos-do-time-brasil/5111617/" target="_blank">Link da mat√©ria do SporTV onde o bot aparece</a></p>

<p>Usamos <a href="https://github.com/Lab21k/node-telegram-bot-api" target="_blank">essa</a> biblioteca em NodeJS, que √© um fork com algumas melhorias que fiz para trabalhar com m√∫ltiplos usu√°rios. Esse cara serve para fazer a comunica√ß√£o com o bot.</p>

<p>Internamente criamos uma biblioteca com m√©todos promisificados, encapsulamentos, ES6 compatibility, que facilitou trabalhar com bots. Posteriormente iremos publicar no GitHub.</p>

<h2 id="como-era">Como era</h2>

<p>A equipe do COB precisava ter uma plataforma para consultar informa√ß√µes relevantes sobre sua opera√ß√£o, facilitar sua equipe a obter informa√ß√£o rapidamente.</p>

<ul>
  <li>
    <p>Permitir pessoas criarem grupos com sub-grupos de pessoas espec√≠ficas. Ex.: Quero falar com a √°rea m√©dica. Bastava clicar nessa op√ß√£o e voc√™ era inserido no grupo de Telegram s√≥ com os m√©dicos a servi√ßo do COB.</p>
  </li>
  <li>
    <p>Consulta de resultados de medalhas. Nessa fun√ß√£o era consultada a base oficial do COB permitindo escolher qual modalidade e dia.</p>
  </li>
  <li>
    <p>Consulta da programa√ß√£o por modalidade e dia.</p>
  </li>
  <li>
    <p>Avisos globais para todos inscritos num sistema de pub/sub.</p>
  </li>
  <li>
    <p>Consulta de incidentes abertos enviando coordenadas geogr√°ficas.</p>
  </li>
</ul>

<p><img src="/assets/images/resultado.jpg" class="reasonable-img-size" alt="Um screenshot do bot consultado os resultados dos jogos" /></p>

<p><img src="/assets/images/programacao.jpg" class="reasonable-img-size" alt="Um screenshot do bot consultando a programa√ß√£o dos jogos" /></p>

<h2 id="algumas-estat√≠sticas">Algumas estat√≠sticas</h2>

<ul>
  <li>
    <p>N√∫mero total de usu√°rio que usaram o sistema e o Bot para coordenar seus trabalhos diariamente na Rio 2016: <strong>268</strong></p>
  </li>
  <li>
    <p>Grupos criados usando a interface do Bot: <strong>89</strong></p>
  </li>
  <li>
    <p>Total de mensagens trocadas nos grupos: <strong>23985</strong></p>
  </li>
</ul>

<h2 id="limita√ß√µes-do-telegram-e-desafios-enfrentados">Limita√ß√µes do Telegram e Desafios enfrentados</h2>

<p>Assim como qualquer API, com o Telegram n√£o seria diferente.</p>

<p>N√≥s precis√°vamos criar os grupos para conectar as pessoas toda hora que fosse solicitado, por√©m, em nosso ambiente de testes come√ßamos a tomar um erro chamado <code class="language-plaintext highlighter-rouge">FLOOD_AWAIT</code> que √© um cl√°ssico e j√° era de se esperar.</p>

<p>Se esse erro desse em produ√ß√£o, toda a opera√ß√£o do COB seria arruinada.</p>

<p>A solu√ß√£o foi criarmos um pool de grupos, e conforme o servidor recebesse o comando de ‚ÄúCriar grupo‚Äù ele ia nesse pool e pegava o grupo j√° criado previamente e adicionava as pessoas dentro dele.</p>

<p>Havia tamb√©m um broadcast de mensagens para todos os envolvidos via Bot. Os Ids dos usu√°rios do Telegram ficavam guardados em outra aplica√ß√£o. Portanto, usamos a t√©cnica de Pub/Sub tendo o Redis como middleware para comunicar processos diferentes. Na pr√°tica, isso era √∫til para serem tomadas as medidas certas como divulgar para a imprensa quando uma medalha havia entrado, por exemplo.</p>

<p>Tivemos problemas quando muitas Promises ficavam em aberto esperando serem respondidas pelos usu√°rios. Isso fazia com que a performance do Bot ca√≠sse de forma impactante. Para resolver isso, criei um gerenciador de Promises em aberto usando <code class="language-plaintext highlighter-rouge">.isPending</code>. Se tivesse uma Promise aberta por mais de 10 minutos, ele matava. Caso o usu√°rio respondesse a uma Promise morta, o Bot redirecionava o fluxo para o in√≠cio.</p>

<h2 id="quantidade-m√≠nima-em-grupo-integra√ß√£o-com-chat-externo-e-prote√ß√µes">Quantidade m√≠nima em grupo, integra√ß√£o com chat externo e prote√ß√µes</h2>

<p>Um grupo dentro do pool tinha de ser criado obrigatoriamente com no m√≠nimo 3 usu√°rios. Um usu√°rio Inviter que seria respons√°vel por convidar os participantes para o grupo (esse usu√°rio precisa ter todos os operadores na sua lista de contato, caso contr√°rio n√£o funciona), um bot para pegar as mensagens e mandar para um sistema de mensageria externo e um usu√°rio respons√°vel pela modera√ß√£o do grupo.</p>

<p>A Integra√ß√£o do que era falado nos grupos com o sistema de mensageria externa ao Telegram s√≥ foi poss√≠vel gra√ßas a uma configura√ß√£o que tem nos bots que se chama <code class="language-plaintext highlighter-rouge">/setprivacy</code> onde voc√™ permite que o bot processe todas as mensagens enviadas.</p>

<p>A autentica√ß√£o/autoriza√ß√£o foi feita toda via backend, onde s√≥ liberavamos acesso aos comandos do telegram (<code class="language-plaintext highlighter-rouge">/programacao</code>, <code class="language-plaintext highlighter-rouge">/resultado</code>, etc) ap√≥s verifica√ß√£o do n√∫mero de celular no banco de dados do sistema externo administrativo. Caso recusado, os <strong>callbacks n√£o eram registrados</strong> para o usu√°rio.</p>

<h2 id="stack-tecnol√≥gica">Stack tecnol√≥gica</h2>

<p>Feito em NodeJS com banco de dados PostgreSQL e Redis como cache. A aplica√ß√£o conseguiu responder rapidamente √†s requisi√ß√µes. Sem gargalos.</p>

<p>Configura√ß√µes da m√°quina de produ√ß√£o: 4 cpus e 8gb de RAM.</p>

<h2 id="considera√ß√µes-finais">Considera√ß√µes finais</h2>

<p>A velocidade desse projeto (feito praticamente √†s v√©speras dos jogos) √© fruto dos Bots solucionarem um tipo espec√≠fico de problema: Aquele que voc√™ precisa processar input e responder para o usu√°rio a informa√ß√£o que ele espera, sem perder tempo e dinheiro projetando UI.</p>

<p>O projeto foi um sucesso. Conseguimos impactar positivamente o andamento das olimp√≠adas e aprendemos muito durante o processo. :)</p>

<p>Quem quiser saber mais sobre bots, eu palestrei no <a href="https://riodevday.github.io/" target="_blank">Rio Dev Day 2016</a> sobre o assunto e criei alguns com c√≥digo aberto que est√£o no meu <a href="https://github.com/raphaklaus" target="_blank">GitHub</a>:</p>

<p><a href="https://github.com/raphaklaus/telegram-news-bot" target="_blank">Captura de news RSS e sintetiza√ß√£o de voz via IBM Watson</a></p>

<p><a href="https://github.com/raphaklaus/telegram-recipe-bot" target="_blank">Scrapper em um site de culin√°ria. Permite chamar o bot em grupos passando um ou mais ingredientes e ele te retorna uma foto, ingredientes e passo a passo de uma receita culin√°ria</a></p>

<p><a href="https://github.com/raphaklaus/telegram-deploy-bot" target="_blank">Bot para fazer deploy de sites via git com enfase em heroku e dokku</a></p>

<p><a href="https://github.com/raphaklaus/telegram-bot-sample" target="_blank">Simples troca de mensagem</a></p>
:ET